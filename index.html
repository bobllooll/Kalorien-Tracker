<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kalorien Sch√§tzer AI</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icon.svg">
    <meta name="theme-color" content="#000000">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LdGe08sAAAAAPsA5RKV2qXbUWFScBJhUQZRS-0K"></script>
    <!-- Error Handler: Falls Schul-WLAN Skripte blockiert -->
    <script>
        window.addEventListener('error', function(e) {
            // Pr√ºft, ob das Haupt-Skript app.js nicht geladen werden konnte
            if (e.target.tagName === 'SCRIPT' && e.target.src && e.target.src.includes('app.js')) {
                const loader = document.getElementById('appLoadingScreen');
                if (loader) {
                    loader.innerHTML = `
                        <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:20px; text-align:center; color:white;">
                            <div style="font-size:40px; margin-bottom:20px;">üõ°Ô∏è</div>
                            <h3>Verbindung blockiert</h3>
                            <p style="color:#ccc; margin-bottom:20px; line-height:1.5;">Das Netzwerk (z.B. Schul-WLAN) blockiert die App-Dateien.<br>Versuche die Standard-Adresse:</p>
                            <a href="https://kalorien-tracker.pages.dev" style="background:#0a84ff; color:white; text-decoration:none; padding:12px 24px; border-radius:12px; font-weight:bold;">Zur .pages.dev Version</a>
                            <p style="font-size:12px; color:#666; margin-top:20px;">Tipp: Installiere die App zu Hause, dann geht sie auch hier.</p>
                        </div>
                    `;
                }
            }
        }, true);
    </script>
</head>
<body>
    <div class="app-container">
        <!-- Globaler Gradient f√ºr SVGs -->
        <svg width="0" height="0" style="position: absolute;">
            <defs>
                <linearGradient id="brandGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#0a84ff" />
                    <stop offset="100%" stop-color="#bf5af2" />
                </linearGradient>
            </defs>
        </svg>

        <!-- Initialer Lade-Screen (Verdeckt alles beim Start) -->
        <div id="appLoadingScreen" class="loading-overlay" style="z-index: 9999; background: #000;">
            <div class="splash-content">
                <img src="icon.svg" class="splash-logo" alt="NutriScan AI">
                <div class="splash-text">NUTRISCAN AI</div>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="auth-screen" class="auth-container">
            <div class="auth-box">
                <img src="icon.svg" class="auth-logo" alt="NutriScan AI">
                <h2>Willkommen</h2>
                <p style="color: #888; margin-bottom: 20px;">Bitte melde dich an, um deine Daten zu speichern.</p>
                <input type="email" id="authEmail" placeholder="E-Mail Adresse" autocomplete="username" inputmode="email">
                <input type="password" id="authPassword" placeholder="Passwort" autocomplete="current-password">
                <button id="loginBtn" class="primary-btn">Einloggen</button>
                <button id="registerBtn" class="secondary-btn">Registrieren</button>
                <button id="forgotPasswordBtn" style="background:none; border:none; color:#888; font-size:12px; margin-top:15px; cursor:pointer; text-decoration:underline;">Passwort vergessen?</button>
                <p id="authError" style="color: #ff453a; margin-top: 10px; font-size: 14px;"></p>
            </div>
        </div>

        <div id="app-content" class="hidden">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>AI Kalorien Scanner</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="installAppBtn" class="icon-btn hidden" title="App installieren">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    </button>
                    <button id="openProfileBtn" class="icon-btn">üë§</button>
                </div>
            </div>
        </header>

        <main>
            <div class="day-nav">
                <button id="prevDayBtn" class="nav-btn">&lt;</button>
                <h2 id="currentDateDisplay">Heute</h2>
                <button id="nextDayBtn" class="nav-btn" disabled>&gt;</button>
            </div>

            <!-- Neuer Bereich: Tagesstatistik -->
            <div id="stats-container" class="stats-box">
                <h3>Dein Tagesbedarf</h3>
                <div id="dailyStats" class="macro-stats"></div>
            </div>

            <!-- Neuer Bereich: Wasser Tracker -->
            <div class="stats-box water-box">
                <div class="water-info">
                    <h3>Wasser</h3>
                    <p><span id="waterCurrent">0</span> / <span id="waterGoal">2500</span> ml</p>
                    <div class="water-controls">
                        <button id="removeWaterBtn" class="water-btn">-</button>
                        <button id="addWaterBtn" class="water-btn">+</button>
                    </div>
                </div>
                <div class="bottle-container">
                    <div class="bottle">
                        <div class="water-fill" id="waterFill"></div>
                    </div>
                </div>
            </div>

            <!-- Neuer Bereich: Historie & Bearbeitung -->
            <div id="historyList"></div>

            <!-- Manueller Eintrag -->
            <div class="manual-entry-container">
                <button id="toggleManualEntryBtn" class="secondary-btn">Snack hinzuf√ºgen +</button>
                <div id="manualEntryForm" class="manual-entry-box hidden">
                    <div class="manual-entry-header">
                        <h3>Eintrag hinzuf√ºgen</h3>
                        <button id="closeManualEntryBtn" class="close-modal-btn">
                            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </div>
                    
                    <!-- Universal Suche -->
                    <div class="search-container">
                        <input type="text" id="productSearchInput" class="main-search-input" placeholder="Produkt suchen oder beschreiben...">
                        
                        <div class="search-toolbar">
                            <button id="productSearchBtn" class="toolbar-btn db-btn">
                                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                                Datenbank
                            </button>
                            <button id="aiTextEstimateBtn" class="toolbar-btn ai-btn">
                                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 9l1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25L19 9zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12l-5.5-2.5zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25L19 15z"/></svg>
                                KI Sch√§tzung
                            </button>
                            <button id="scanInManualBtn" class="toolbar-btn scan-btn">
                                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm8 0h-2v2h2V3zm2 8h2v-2h-2v2zm0-4h2V5h-2v2zm0 12h2c0 1.1-.9 2-2 2v-2zm0-4h2v-2h-2v2zm-4 4h-2v2h2v-2zm0-4h-2v2h2v-2zm-4 4H7v2h2v-2z"/></svg>
                                Barcode
                            </button>
                        </div>
                        
                        <div style="font-size: 10px; color: #666; text-align: center; margin-bottom: 15px; margin-top: -10px;">
                            ‚ö†Ô∏è KI-Werte sind Sch√§tzungen. Bitte auf Plausibilit√§t pr√ºfen.
                        </div>
                        
                        <div id="searchResults" class="search-results"></div>
                    </div>

                    <!-- Details / Manuelle Eingabe -->
                    <div class="manual-form-grid">
                        <div class="form-group full-width">
                            <label>Name</label>
                            <input type="text" id="manualName" placeholder="z.B. Banane">
                        </div>

                        <div class="form-group full-width">
                            <label>Menge & Einheit</label>
                            <div class="amount-row">
                                <input type="number" id="manualAmount" placeholder="0" inputmode="decimal">
                                <select id="manualUnit" class="styled-select small-select">
                                    <option value="g">g</option>
                                    <option value="ml">ml</option>
                                    <option value="Stk.">Stk.</option>
                                </select>
                            </div>
                            <div class="quick-amounts" id="quickAmountsContainer">
                                <button class="quick-amt-btn" data-value="100">100</button>
                                <button class="quick-amt-btn" data-value="250">250</button>
                                <button class="quick-amt-btn" data-value="500">500</button>
                                <button class="quick-amt-btn" data-value="1000">1000</button>
                            </div>
                        </div>

                        <div class="macros-row">
                            <div class="macro-input calories">
                                <label>Kalorien</label>
                                <input type="number" id="manualCalories" placeholder="0" inputmode="decimal">
                            </div>
                            <div class="macro-input protein">
                                <label>Protein</label>
                                <input type="number" id="manualProtein" placeholder="0" inputmode="decimal">
                            </div>
                            <div class="macro-input fat">
                                <label>Fett</label>
                                <input type="number" id="manualFat" placeholder="0" inputmode="decimal">
                            </div>
                            <div class="macro-input carbs">
                                <label>Carbs</label>
                                <input type="number" id="manualCarbs" placeholder="0" inputmode="decimal">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button id="saveManualEntryBtn" class="primary-btn" style="flex: 1;">Hinzuf√ºgen</button>
                        <button id="saveManualAsRecipeBtn" class="secondary-btn" style="flex: 0 0 60px; border-color: #9c27b0; color: #e1bee7; display: flex; align-items: center; justify-content: center;" title="Als Rezept speichern">
                            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Profil Modal (API Keys & Logout) -->
            <div id="profileModal" class="manual-entry-box hidden">
                <div class="manual-entry-header">
                    <h3>Profil & Einstellungen</h3>
                    <button id="closeProfileBtn" class="close-modal-btn">X</button>
                </div>
                
                <!-- Bereich 1: K√∂rperdaten & Berechnung -->
                <div class="profile-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 class="section-title" style="margin: 0;">Dein Ziel & K√∂rper</h4>
                        <svg id="infoIconBtn" class="icon-svg" viewBox="0 0 24 24" style="color: #bf5af2; cursor: pointer; width: 20px; height: 20px;">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                    </div>

                    <div id="infoText" class="info-box hidden">
                        <p style="margin: 0; font-size: 12px; color: #ccc; line-height: 1.5;">
                            <strong>Berechnungsgrundlage:</strong><br>
                            Wir nutzen die <em>Mifflin-St Jeor Formel</em> (Goldstandard).<br>
                            üìâ <strong>Abnehmen:</strong> Defizit von 500 kcal.<br>
                            üí™ <strong>Aufbau:</strong> √úberschuss von 300 kcal.<br>
                            ü•© <strong>Protein:</strong> 1.6g - 2.0g pro kg K√∂rpergewicht.
                        </p>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Zielsetzung</label>
                        <select id="profileGoal" class="styled-select">
                            <option value="maintain">Gewicht halten</option>
                            <option value="lose">Abnehmen (Defizit)</option>
                            <option value="gain">Muskelaufbau (√úberschuss)</option>
                        </select>
                    </div>

                    <div class="profile-grid">
                        <div class="form-group"><label>Gewicht (kg)</label><input type="number" id="profileWeight" placeholder="kg"></div>
                        <div class="form-group"><label>Gr√∂√üe (cm)</label><input type="number" id="profileHeight" placeholder="cm"></div>
                        <div class="form-group"><label>Alter</label><input type="number" id="profileAge" placeholder="Jahre"></div>
                        <div class="form-group"><label>Geschlecht</label>
                            <select id="profileGender" class="styled-select">
                                <option value="male">Mann</option>
                                <option value="female">Frau</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group full-width" style="margin-top: 10px;">
                        <label>Aktivit√§tslevel</label>
                        <select id="profileActivity" class="styled-select">
                            <option value="1.2">Wenig Bewegung (B√ºro)</option>
                            <option value="1.375">Leicht aktiv (1-3x Sport/Woche)</option>
                            <option value="1.55">Moderat aktiv (3-5x Sport/Woche)</option>
                            <option value="1.725">Sehr aktiv (6-7x Sport/Woche)</option>
                        </select>
                    </div>

                    <button id="calcProfileBtn" class="secondary-btn" style="margin: 15px 0; font-size: 14px; padding: 12px;">üßÆ Bedarf automatisch berechnen</button>
                </div>

                <!-- Bereich 2: Tageslimits (Ergebnis) -->
                <div class="profile-section">
                    <h4 class="section-title">Deine Tageslimits (Manuell anpassbar)</h4>
                    <div class="macros-row">
                        <div class="macro-input calories"><label>Kcal</label><input type="number" id="goalCalories" placeholder="2500"></div>
                        <div class="macro-input protein"><label>Prot</label><input type="number" id="goalProtein" placeholder="150"></div>
                        <div class="macro-input fat"><label>Fett</label><input type="number" id="goalFat" placeholder="80"></div>
                        <div class="macro-input carbs"><label>Carbs</label><input type="number" id="goalCarbs" placeholder="300"></div>
                    </div>
                    <div class="form-group full-width" style="margin-top: 10px;"><label>Wasserziel (ml)</label><input type="number" id="goalWater" placeholder="2500" style="text-align: center;"></div>
                </div>

                <div class="profile-section" style="margin-top: 20px; border-top: 1px solid #222; padding-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 class="section-title" style="margin: 0;">API Keys (Erweitert)</h4>
                        <span id="apiUsageDisplay" style="font-size: 11px; color: #666; background: rgba(255,255,255,0.05); padding: 4px 8px; border-radius: 6px;">Heute: 0</span>
                    </div>
                    <input type="text" id="profileGeminiKey" placeholder="Google Gemini API Key" style="margin-bottom: 10px;">
                    <input type="text" id="profileOpenAIKey" placeholder="OpenAI API Key (Optional)">
                </div>

                <button id="saveProfileBtn" class="primary-btn" style="margin-top: 20px;">Speichern & Schlie√üen</button>
                <button id="logoutBtn" class="secondary-btn" style="margin-top: 10px; border-color: #ff453a; color: #ff453a;">Abmelden</button>
                <button id="openLegalBtn" class="secondary-btn" style="margin-top: 10px; font-size: 12px; padding: 10px; border: none; background: rgba(255,255,255,0.05);">‚öñÔ∏è Datenschutz & Impressum</button>
                <button id="openTutorialBtn" class="secondary-btn" style="margin-top: 5px; font-size: 12px; padding: 10px; border: none; background: rgba(255,255,255,0.05); color: #bf5af2;">‚ùì Anleitung & Hilfe</button>
                <p style="font-size: 10px; color: #555; text-align: center; margin-top: 20px;">App Version: v8.0</p>
            </div>

            <!-- Hauptaktionen: Grid Layout -->
            <div class="action-grid">
                <!-- AI Scan Kachel -->
                <div class="action-card ai-card" style="position: relative;">
                    <label for="cameraInput" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; z-index: 1;">
                        <div class="card-icon">
                            <svg class="icon-svg" style="width: 32px; height: 32px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3.2"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        </div>
                        <span class="card-title">AI Foto Scan</span>
                        <span class="card-desc">Erkennt dein Essen automatisch</span>
                    </label>
                    <input type="file" id="cameraInput" accept="image/*" capture="environment">
                    
                    <label for="galleryInput" style="position: absolute; bottom: 10px; right: 10px; width: 40px; height: 40px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2);">
                        <svg class="icon-svg" viewBox="0 0 24 24" style="width: 20px; height: 20px;"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                    </label>
                    <input type="file" id="galleryInput" accept="image/*" multiple>
                </div>
                
                <!-- Rezepte Kachel -->
                <button id="recipesBtn" class="action-card recipe-card">
                    <div class="card-icon">
                        <svg class="icon-svg" style="width: 32px; height: 32px;" viewBox="0 0 24 24"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/></svg>
                    </div>
                    <span class="card-title">Rezepte</span>
                    <span class="card-desc">Deine Sammlung & Vorlagen</span>
                </button>
            </div>
            
            <!-- Analyse Modal (Neu gestaltet) -->
            <div id="analysisModal" class="manual-entry-box hidden">
                <div class="manual-entry-header">
                    <h3>Analyse pr√ºfen</h3>
                    <button id="closeAnalysisBtn" class="close-modal-btn">X</button>
                </div>
                
                <div class="analysis-layout">
                    <div class="image-wrapper" id="imagePreviewContainer">
                        <!-- Bilder werden hier eingef√ºgt -->
                    </div>
                    <div class="input-wrapper">
                        <label for="descriptionInput" style="font-size: 12px; color: #888; display: block; margin-bottom: 5px;">Notiz an die KI (Optional):</label>
                        <textarea id="descriptionInput" placeholder="z.B. 'nur die H√§lfte gegessen' oder 'mit extra K√§se'" rows="2"></textarea>
                    </div>
                </div>
                
                <!-- Hybrid Mode Toggle -->
                <div class="toggle-row">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <div style="font-weight: 600; font-size: 14px;">Marken-Scan (Hybrid)</div>
                            <svg id="hybridInfoBtn" class="icon-svg" viewBox="0 0 24 24" style="width: 16px; height: 16px; color: #bf5af2; cursor: pointer; opacity: 0.8;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                        </div>
                        <div style="font-size: 11px; color: #888;">F√ºr verpackte Produkte (Datenbank-Check)</div>
                    </div>
                    <label class="switch"><input type="checkbox" id="hybridModeToggle"><span class="slider"></span></label>
                </div>
                
                <div id="hybridInfoText" class="info-box hidden" style="margin-top: -5px;">
                    <p style="margin: 0; font-size: 12px; color: #ccc; line-height: 1.4;">
                        <strong>So funktioniert's:</strong><br>
                        1. Die KI sucht nach Marken/Produkten (z.B. "Barilla Pesto").<br>
                        2. App l√§dt <strong>echte N√§hrwerte</strong> aus der Datenbank.<br>
                        3. KI berechnet damit die exakte Menge.<br>
                        <em style="color: #bf5af2; display: block; margin-top: 5px;">Ideal f√ºr Supermarkt-Produkte, nicht f√ºr Selbstgekochtes.</em>
                        <br>
                        <span style="color: #ff453a; display: block; margin-top: 8px; font-weight: bold;">‚ö†Ô∏è Hinweis: Verbraucht 2 API-Anfragen! (Google Free Tier hat ca. 20 Anfragen/Tag).</span>
                    </p>
                </div>

                <button id="analyzeBtn" class="primary-btn" style="margin-top: 10px;">Jetzt analysieren ‚ú®</button>
            </div>

            <div id="resultArea" class="result hidden"></div>

            <!-- Rezepte Modal -->
            <div id="recipesModal" class="manual-entry-box hidden">
                <div class="manual-entry-header">
                    <h3>Meine Rezepte</h3>
                    <button id="closeRecipesBtn" class="close-modal-btn">X</button>
                </div>
                <div id="recipesList" class="recipes-list">
                    <!-- Liste wird per JS gef√ºllt -->
                </div>
                <button id="createNewRecipeBtn" class="primary-btn" style="margin-top: 15px;">+ Neues Rezept erstellen</button>
            </div>

            <!-- Rezept Erstellen Modal -->
            <div id="createRecipeModal" class="manual-entry-box hidden">
                 <div class="manual-entry-header">
                    <h3>Rezept erstellen</h3>
                    <button id="closeCreateRecipeBtn" class="close-modal-btn">X</button>
                </div>
                <div class="manual-form-grid">
                     <div class="form-group full-width">
                        <label>Name des Gerichts</label>
                        <input type="text" id="recipeName" placeholder="z.B. Mein Fr√ºhst√ºck">
                    </div>
                    <div class="macros-row">
                        <div class="macro-input calories"><label>Kcal</label><input type="number" id="recipeCalories" placeholder="0"></div>
                        <div class="macro-input protein"><label>Prot</label><input type="number" id="recipeProtein" placeholder="0"></div>
                        <div class="macro-input fat"><label>Fett</label><input type="number" id="recipeFat" placeholder="0"></div>
                        <div class="macro-input carbs"><label>Carbs</label><input type="number" id="recipeCarbs" placeholder="0"></div>
                    </div>
                </div>
                <button id="saveNewRecipeBtn" class="primary-btn" style="margin-top: 20px;">Rezept speichern</button>
            </div>

            <p class="disclaimer-text">‚ö†Ô∏è Hinweis: Alle Werte sind KI-generierte Sch√§tzungen und dienen nur zur groben Orientierung.</p>
        </main>

        <!-- Scanner Modal (Vollbild) -->
        <div id="scannerModal" class="manual-entry-box hidden" style="width: 100%; height: 100%; max-width: none; max-height: none; border-radius: 0; background: #000; top: 0; left: 0; transform: none; padding: 0; border: none; box-shadow: none;">
            <div class="manual-entry-header" style="position: absolute; top: 40px; left: 20px; right: 20px; z-index: 10; border-bottom: none;">
                <h3 style="text-shadow: 0 2px 4px rgba(0,0,0,0.8);">Barcode Scannen</h3>
                <button id="closeScannerBtn" class="close-modal-btn" style="background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px;">X</button>
            </div>
            <div id="reader" style="width: 100%; height: 100%; object-fit: cover;"></div>
            
            <!-- Visuelles Feedback Overlay -->
            <div class="scanner-overlay">
                <div class="scanner-box">
                    <div class="scanner-corner top-left"></div>
                    <div class="scanner-corner top-right"></div>
                    <div class="scanner-corner bottom-left"></div>
                    <div class="scanner-corner bottom-right"></div>
                    <div class="scanner-line"></div>
                </div>
                <p style="margin-top: 30px; color: white; background: rgba(0,0,0,0.5); padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 500; backdrop-filter: blur(5px);">Barcode im Rahmen platzieren</p>
            </div>
        </div>

        <!-- Barcode Ergebnis Modal -->
        <div id="barcodeResultModal" class="manual-entry-box hidden">
            <div class="manual-entry-header">
                <h3>Produkt gefunden</h3>
                <button id="closeBarcodeResultBtn" class="close-modal-btn">X</button>
            </div>
            <h4 id="barcodeProductName" style="margin: 0 0 10px 0; color: #0a84ff; font-size: 18px;"></h4>
            <div style="font-size: 13px; color: #888; margin-bottom: 20px; background: #1a1a1a; padding: 10px; border-radius: 8px;">
                Basis: <span id="barcode100gInfo"></span>
            </div>
            
            <label style="font-size: 14px; color: #ccc; display: block; margin-bottom: 8px;">Gegessene Menge (g/ml):</label>
            <input type="number" id="barcodeWeight" value="100" placeholder="Gramm" inputmode="decimal" style="font-size: 20px; font-weight: bold; color: #30d158;">
            
            <div id="barcodeCalculatedStats" style="margin: 20px 0; text-align: center; color: #fff;"></div>

            <button id="saveBarcodeEntryBtn" class="primary-btn">Hinzuf√ºgen</button>
        </div>

        </div>

        <!-- Rechtliches & Datenschutz Modal (Au√üerhalb von app-content f√ºr Login-Zugriff) -->
        <div id="legalModal" class="manual-entry-box hidden">
            <div class="manual-entry-header">
                <h3>Rechtliches</h3>
                <button id="closeLegalBtn" class="close-modal-btn">X</button>
            </div>
            <div class="legal-content" style="font-size: 13px; color: #ccc; line-height: 1.6;">
                <h4 style="color: white; margin-bottom: 5px;">1. Datenspeicherung</h4>
                <p>Deine Ern√§hrungsdaten, Rezepte und Profileinstellungen werden sicher in einer <strong>Google Firebase Datenbank</strong> (Cloud Firestore) gespeichert. Die Authentifizierung erfolgt ebenfalls √ºber Google Firebase Auth.</p>
                
                <h4 style="color: white; margin-bottom: 5px; margin-top: 15px;">2. Genutzte APIs & Dienste</h4>
                <ul style="padding-left: 20px; margin: 5px 0;">
                    <li><strong>Google Gemini / OpenAI:</strong> Zur Bildanalyse werden Fotos an die API des jeweiligen Anbieters gesendet. Die Bilder werden dort laut Anbieter nur zur Analyse verarbeitet und nicht dauerhaft gespeichert (Stateless).</li>
                    <li><strong>Open Food Facts:</strong> Produktdaten werden aus der Open Food Facts Datenbank abgerufen (Lizenz: ODbL).</li>
                </ul>

                <h4 style="color: white; margin-bottom: 5px; margin-top: 15px;">3. Lokaler Speicher (Cookies)</h4>
                <p>Wir nutzen den lokalen Speicher deines Ger√§ts (LocalStorage/Cookies), um deinen Login-Status, deine API-Keys (verschl√ºsselt) und App-Einstellungen zu speichern. Dies ist f√ºr die Funktion der App technisch notwendig.</p>

                <h4 style="color: white; margin-bottom: 5px; margin-top: 15px;">4. Impressum & Kontakt</h4>
                <p>Das vollst√§ndige Impressum und die Datenschutzerkl√§rung findest du auf unserer Hauptseite:</p>
                <a href="https://DEINE-HAUPT-DOMAIN.de/impressum" target="_blank" style="display: inline-block; margin-top: 10px; background: rgba(255,255,255,0.1); color: #fff; text-decoration: none; padding: 10px 15px; border-radius: 8px; font-weight: bold;">üåê Zum Impressum √∂ffnen</a>

                <h4 style="color: white; margin-bottom: 5px; margin-top: 15px;">5. Medizinischer Haftungsausschluss</h4>
                <p>Diese App dient ausschlie√ülich Informationszwecken und zur groben Orientierung. Sie stellt <strong>keine medizinische Beratung</strong>, Diagnose oder Behandlung dar. Die berechneten Werte sind KI-generierte Sch√§tzungen und k√∂nnen fehlerhaft sein.</p>
                <p>Konsultiere bei gesundheitlichen Fragen oder vor einer Ern√§hrungsumstellung immer einen Arzt oder Ern√§hrungsberater. Der Betreiber √ºbernimmt keine Haftung f√ºr die Richtigkeit der Daten oder gesundheitliche Folgen.</p>
            </div>
        </div>

        <!-- Tutorial / First Run Modal -->
        <div id="tutorialModal" class="manual-entry-box hidden">
            <div class="manual-entry-header">
                <h3>Erste Schritte üöÄ</h3>
                <button id="closeTutorialBtn" class="close-modal-btn">X</button>
            </div>
            <div style="font-size: 14px; color: #ddd; line-height: 1.6;">
                <p>Willkommen bei NutriScan AI! Damit die App funktioniert, sind folgende Schritte n√∂tig:</p>
                
                <div style="background: rgba(191, 90, 242, 0.1); border: 1px solid rgba(191, 90, 242, 0.3); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <strong style="color: #bf5af2; display: block; margin-bottom: 5px;">1. Kostenlosen KI-Key holen</strong>
                    Die App nutzt Google Gemini zur Bilderkennung. Du brauchst deinen eigenen (kostenlosen) Schl√ºssel.<br>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" style="display: inline-block; margin-top: 10px; background: #bf5af2; color: white; text-decoration: none; padding: 8px 12px; border-radius: 8px; font-weight: bold;">üîë Key hier erstellen</a>
                </div>

                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <strong style="color: white; display: block; margin-bottom: 5px;">2. Key eintragen</strong>
                    Gehe ins Profil (üë§ oben rechts) und f√ºge den Key bei <strong>"Google Gemini API Key"</strong> ein.
                </div>

                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                    <strong style="color: white; display: block; margin-bottom: 5px;">3. K√∂rperdaten eintragen</strong>
                    Damit dein Kalorienbedarf berechnet werden kann, trage bitte dein Gewicht, Gr√∂√üe und Alter im Profil ein.
                </div>

                <p>Danach kannst du einfach Fotos von deinem Essen machen!</p>
                <button id="finishTutorialBtn" class="primary-btn">Verstanden, los geht's!</button>
            </div>
        </div>

        <!-- Update Modal (Neu) -->
        <div id="updateModal" class="manual-entry-box hidden" style="z-index: 9999;">
            <div class="manual-entry-header">
                <h3>Update verf√ºgbar ‚ú®</h3>
            </div>
            <div style="text-align: center; padding: 20px 0;">
                <div style="font-size: 40px; margin-bottom: 15px;">üì≤</div>
                <p style="color: #ddd; line-height: 1.5; margin-bottom: 25px;">Eine neue Version der App ist bereit!<br>Lade kurz neu, um die neuesten Features zu nutzen.</p>
                <button id="refreshAppBtn" class="primary-btn" style="width: 100%;">Jetzt aktualisieren</button>
            </div>
        </div>
    </div>

    <!-- Lade-Overlay (Spinner) -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <img src="icon.svg" class="ai-loading-logo" alt="AI Processing">
        <p id="loadingText">Lade...</p>
    </div>

    <!-- Cookie Banner -->
    <div id="cookieBanner" class="cookie-banner hidden">
        <p style="margin: 0; font-size: 13px; color: #ddd; line-height: 1.4;">üç™ Wir nutzen Cookies f√ºr den Login (notwendig) und zur Verbesserung der App (optional).</p>
        <div class="cookie-buttons">
            <button id="declineCookiesBtn" class="cookie-btn-secondary">Nur Notwendige</button>
            <button id="acceptCookiesBtn" class="cookie-btn-primary">Alle akzeptieren</button>
        </div>
    </div>

    <!-- Toast Container f√ºr Benachrichtigungen -->
    <div id="toast-container"></div>

    <script type="module" src="app.js"></script>
</body>
</html>