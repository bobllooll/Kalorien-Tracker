<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalorien Sch√§tzer AI</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icon.svg">
    <meta name="theme-color" content="#000000">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="auth-screen" class="auth-container">
            <div class="auth-box">
                <h2>Willkommen</h2>
                <p style="color: #888; margin-bottom: 20px;">Bitte melde dich an, um deine Daten zu speichern.</p>
                <input type="email" id="authEmail" placeholder="E-Mail Adresse" autocomplete="username" inputmode="email">
                <input type="password" id="authPassword" placeholder="Passwort" autocomplete="current-password">
                <button id="loginBtn" class="primary-btn">Einloggen</button>
                <button id="registerBtn" class="secondary-btn">Registrieren</button>
                <p id="authError" style="color: #ff453a; margin-top: 10px; font-size: 14px;"></p>
            </div>
        </div>

        <div id="app-content" class="hidden">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>AI Kalorien Scanner</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button id="installAppBtn" class="icon-btn hidden" title="App installieren">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    </button>
                    <button id="openProfileBtn" class="icon-btn">üë§</button>
                </div>
            </div>
        </header>

        <main>
            <div class="day-nav">
                <button id="prevDayBtn" class="nav-btn">&lt;</button>
                <h2 id="currentDateDisplay">Heute</h2>
                <button id="nextDayBtn" class="nav-btn" disabled>&gt;</button>
            </div>

            <!-- Neuer Bereich: Tagesstatistik -->
            <div id="stats-container" class="stats-box">
                <h3>Dein Tagesbedarf</h3>
                <div id="dailyStats" class="macro-stats"></div>
            </div>

            <!-- Neuer Bereich: Historie & Bearbeitung -->
            <div id="historyList"></div>

            <!-- Manueller Eintrag -->
            <div class="manual-entry-container">
                <button id="toggleManualEntryBtn" class="secondary-btn">Snack hinzuf√ºgen +</button>
                <div id="manualEntryForm" class="manual-entry-box hidden">
                    <div class="manual-entry-header">
                        <h3>Manueller Eintrag</h3>
                        <button id="closeManualEntryBtn" class="close-modal-btn">
                            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                        </button>
                    </div>
                    <button id="scanInManualBtn" class="secondary-btn" style="margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm8 0h-2v2h2V3zm2 8h2v-2h-2v2zm0-4h2V5h-2v2zm0 12h2c0 1.1-.9 2-2 2v-2zm0-4h2v-2h-2v2zm-4 4h-2v2h2v-2zm0-4h-2v2h2v-2zm-4 4H7v2h2v-2zm-4-4H7v2h2v-2z"/></svg>
                        Barcode scannen
                    </button>
                    <input type="text" id="manualName" placeholder="Name (z.B. Protein-Riegel)">
                    <input type="number" id="manualCalories" placeholder="Kalorien" inputmode="decimal">
                    <div class="macro-inputs-grid">
                        <input type="number" id="manualProtein" placeholder="Prot (g)" inputmode="decimal">
                        <input type="number" id="manualFat" placeholder="Fett (g)" inputmode="decimal">
                        <input type="number" id="manualCarbs" placeholder="Carbs (g)" inputmode="decimal">
                    </div>
                    <button id="saveManualEntryBtn" class="primary-btn">Speichern</button>
                </div>
            </div>

            <!-- Profil Modal (API Keys & Logout) -->
            <div id="profileModal" class="manual-entry-box hidden">
                <div class="manual-entry-header">
                    <h3>Profil & Einstellungen</h3>
                    <button id="closeProfileBtn" class="close-modal-btn">X</button>
                </div>
                <p style="color: #999; font-size: 13px; line-height: 1.5; margin-bottom: 20px;">
                    üîí <strong>Sicherheitshinweis:</strong> Deine API Keys werden mit deinem Passwort verschl√ºsselt. Das bedeutet: Du kannst dich auf jedem Ger√§t einloggen und hast sofort Zugriff, solange du dein Passwort kennst. Wir speichern dein Passwort niemals im Klartext.
                </p>
                
                <input type="text" id="profileGeminiKey" placeholder="Google Gemini API Key">
                <input type="text" id="profileOpenAIKey" placeholder="OpenAI API Key (Optional)">
                <button id="saveProfileBtn" class="primary-btn">Speichern</button>
                <button id="logoutBtn" class="secondary-btn" style="margin-top: 15px; border-color: #ff453a; color: #ff453a;">Abmelden</button>
                <p style="font-size: 10px; color: #555; text-align: center; margin-top: 20px;">App Version: v5.0</p>
            </div>

            <div class="input-group" style="flex-direction: row; gap: 10px;">
                <label for="cameraInput" class="camera-btn" style="flex: 1;">
                    <svg class="icon-svg" viewBox="0 0 24 24">
                        <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                    </svg>
                    Foto aufnehmen
                </label>
                <!-- capture="environment" √∂ffnet auf Handys direkt die Hauptkamera -->
                <input type="file" id="cameraInput" accept="image/*" capture="environment">
                
                <button id="startScannerBtn" class="camera-btn" style="flex: 1;">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 5h2V3c-1.1 0-2 .9-2 2zm0 8h2v-2H3v2zm4 8h2v-2H7v2zM3 9h2V7H3v2zm10-6h-2v2h2V3zm6 0v2h2c0-1.1-.9-2-2-2zM5 21v-2H3c0 1.1.9 2 2 2zm-2-4h2v-2H3v2zM9 3H7v2h2V3zm8 0h-2v2h2V3zm2 8h2v-2h-2v2zm0-4h2V5h-2v2zm0 12h2c0 1.1-.9 2-2 2v-2zm0-4h2v-2h-2v2zm-4 4h-2v2h2v-2zm0-4h-2v2h2v-2zm-4 4H7v2h2v-2zm-4-4H7v2h2v-2z"/></svg>
                    Scan
                </button>
            </div>
            
            <div id="preview-container">
                <img id="imagePreview" alt="Vorschau" style="display: none;">
            </div>

            <div class="input-group">
                <input type="text" id="descriptionInput" placeholder="Zus√§tzliche Beschreibung (z.B. 'Mit extra K√§se')">
            </div>

            <button id="analyzeBtn" disabled>Kalorien sch√§tzen</button>

            <div id="resultArea" class="result hidden"></div>

            <p class="disclaimer-text">‚ö†Ô∏è Hinweis: Alle Werte sind KI-generierte Sch√§tzungen und dienen nur zur groben Orientierung.</p>
        </main>

        <!-- Scanner Modal (Vollbild) -->
        <div id="scannerModal" class="manual-entry-box hidden" style="width: 100%; height: 100%; max-width: none; max-height: none; border-radius: 0; background: #000; top: 0; left: 0; transform: none; padding: 0;">
            <div class="manual-entry-header" style="position: absolute; top: 40px; left: 20px; right: 20px; z-index: 10; border-bottom: none;">
                <h3 style="text-shadow: 0 2px 4px rgba(0,0,0,0.8);">Barcode Scannen</h3>
                <button id="closeScannerBtn" class="close-modal-btn" style="background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px;">X</button>
            </div>
            <div id="reader" style="width: 100%; height: 100%; object-fit: cover;"></div>
        </div>

        <!-- Barcode Ergebnis Modal -->
        <div id="barcodeResultModal" class="manual-entry-box hidden">
            <div class="manual-entry-header">
                <h3>Produkt gefunden</h3>
                <button id="closeBarcodeResultBtn" class="close-modal-btn">X</button>
            </div>
            <h4 id="barcodeProductName" style="margin: 0 0 10px 0; color: #0a84ff; font-size: 18px;"></h4>
            <div style="font-size: 13px; color: #888; margin-bottom: 20px; background: #1a1a1a; padding: 10px; border-radius: 8px;">
                Basis: <span id="barcode100gInfo"></span>
            </div>
            
            <label style="font-size: 14px; color: #ccc; display: block; margin-bottom: 8px;">Gegessene Menge (g/ml):</label>
            <input type="number" id="barcodeWeight" value="100" placeholder="Gramm" inputmode="decimal" style="font-size: 20px; font-weight: bold; color: #30d158;">
            
            <div id="barcodeCalculatedStats" style="margin: 20px 0; text-align: center; color: #fff;"></div>

            <button id="saveBarcodeEntryBtn" class="primary-btn">Hinzuf√ºgen</button>
        </div>

        </div>
    </div>

    <!-- Lade-Overlay (Spinner) -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p id="loadingText">Lade...</p>
    </div>
    <script type="module" src="app.js"></script>
</body>
</html>